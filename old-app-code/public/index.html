<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>John King's Store Directory & FAQ</title>
    <meta name="description" content="Find what interests you faster - browse by subject and category using the store subject directory. John K. King Used and Rare Books has over one million books and an unprecedented collection of rare and collectors editions.">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --safe-area-inset-top: env(safe-area-inset-top, 0px);
      --safe-area-inset-right: env(safe-area-inset-right, 0px);
      --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-inset-left: env(safe-area-inset-left, 0px);
    }
    body {
      font-family: 'Fira Sans', sans-serif;
      padding-bottom: var(--safe-area-inset-bottom);
      padding-top: var(--safe-area-inset-top);
    }
    .table-container table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .table-container th, .table-container td { border: 1px solid #e2e8f0; padding: 0.75rem; text-align: left; }
    .table-container th { background-color: #f1f5f9; font-weight: 600; color: #334155; }
    .table-container tr:nth-child(even) { background-color: #f8fafc; }
    .table-container tr:hover { background-color: #e2e8f0; }
    
    #fullscreen-map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
    #fullscreen-map-close { position: absolute; top: calc(1.5rem + var(--safe-area-inset-top)); right: calc(1.5rem + var(--safe-area-inset-right)); font-size: 2.5rem; color: white; cursor: pointer; z-index: 101; line-height: 1; }
    #zoom-container { max-width: calc(90vw - var(--safe-area-inset-left) - var(--safe-area-inset-right)); max-height: calc(90vh - var(--safe-area-inset-top) - var(--safe-area-inset-bottom)); overflow: auto; background: white; border: 4px solid white; border-radius: 0.5rem; }
    #fullscreen-map img { max-width: 100%; max-height: 100%; object-fit: contain; display: block; }
    #back-to-top { display: none; transition: opacity 0.3s, transform 0.3s; opacity: 0; transform: translateY(10px); position: fixed; width: 3.5rem; height: 3.5rem; font-size: 1.75rem; z-index: 50; bottom: calc(1.5rem + var(--safe-area-inset-bottom)); right: calc(1.5rem + var(--safe-area-inset-right)); }
    #back-to-top.visible { display: flex; opacity: 1; transform: translateY(0); }

    /* Persistent Employee Panel */
    #persistent-employee-panel {
      bottom: calc(1rem + var(--safe-area-inset-bottom));
      right: calc(1rem + var(--safe-area-inset-right));
      transition: opacity 0.3s ease-in-out;
    }
    #persistent-employee-panel.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #panel-minimized, #panel-expanded {
      transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out;
    }
    #panel-minimized.hidden, #panel-expanded.hidden {
      opacity: 0;
      transform: scale(0.8);
      pointer-events: none;
      position: absolute;
    }
    /* Adjust back-to-top button when employee panel is visible and expanded */
    #back-to-top.with-employee-panel {
      bottom: calc(1.5rem + var(--safe-area-inset-bottom) + 200px);
    }
    #back-to-top.with-employee-panel-minimized {
      bottom: calc(1.5rem + var(--safe-area-inset-bottom) + 70px);
    }
    #help-modal-overlay, #feedback-modal-overlay, #suggestion-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 110; backdrop-filter: blur(4px); }
    #help-modal { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 500px; position: relative; max-height: calc(90vh - var(--safe-area-inset-top) - var(--safe-area-inset-bottom)); overflow-y: auto; }
    #help-modal .absolute { top: 0.75rem; right: 1rem; }
    #open-panel { top: 50%; right: 0; transform: translateY(-50%); right: var(--safe-area-inset-right); }
    #info-panel { height: calc(100% - var(--safe-area-inset-top) - var(--safe-area-inset-bottom)); top: var(--safe-area-inset-top); right: var(--safe-area-inset-right); }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
    nav a.active { background-color: #4b5563; color: white; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Employee Page Styles */
    .employee-subpage { display: none; }
    .employee-subpage.active { display: block; animation: fadeIn 0.3s ease-in-out; }
    #employee-nav {
      --bg: #2b1e16; --bg-light: #3a2a20; --accent: #c6a882; --text: #ffffff; --muted: #e9e3dc;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      width: 100%; position: relative; z-index: 0;
    }
    #employee-nav .vnav { background: var(--bg); color: var(--text); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); position: sticky; top: 16px; width: 100%; box-sizing: border-box; }
    #employee-nav .vnav-title { font-size: 0.9rem; letter-spacing: 0.04em; text-transform: uppercase; opacity: 0.9; margin: 6px 8px 10px; }
    #employee-nav ul { list-style: none; margin: 0; padding: 0; display: grid; gap: 6px; }
    #employee-nav a { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--text); background: var(--bg-light); padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06); line-height: 1.2; font-size: 0.95rem; transition: background 140ms ease, transform 80ms ease, box-shadow 140ms ease; width: 100%; box-sizing: border-box; }
    #employee-nav a:hover { background: var(--accent); color: #1f130d; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
    #employee-nav a:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
    #employee-nav a.active { background: var(--accent); color: #1f130d; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06); font-weight: 600; }
    
    /* FAQ STYLES */
    .faq-card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .faq-card:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); }
    .faq-question { font-size: 1.125rem; font-weight: 600; color: #1f2937; cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0; }
    .faq-answer { color: #374151; font-size: 0.95rem; line-height: 1.6; max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.3s ease-out, opacity 0.3s ease-out; }
    .faq-answer.expanded { max-height: 500px; opacity: 1; }
    .faq-toggle-icon { font-size: 1.5rem; transition: transform 0.3s ease; }
    .faq-toggle-icon.rotated { transform: rotate(180deg); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8">
    <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">John K. King Bookstore Directory & FAQ</h1>
    </header>

    <nav class="flex justify-center border-b border-gray-200 mb-6">
        <a href="https://www.johnkingbooksdetroit.com" target="_blank" rel="noopener noreferrer" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-t-lg transition-colors">John King Home</a>
        <a href="#/directory" data-page="directory" class="nav-link px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-t-lg transition-colors">Directory</a>
        <a href="#/faq" data-page="faq" class="nav-link px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-t-lg transition-colors">FAQ</a>
        <a href="#" id="feedback-link" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-t-lg transition-colors">Feedback</a>
    </nav>

    <main>
        <div id="page-directory" class="page">
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
              <input id="directory-search-input" type="text" placeholder="Search a subject..." class="flex-1 w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-stone-500 focus:outline-none" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="search" />
              <select id="floor-filter" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-stone-500 focus:outline-none">
                <option value="">All Floors</option>
              </select>
              <button id="directory-search-button" class="w-full sm:w-auto px-6 py-2 bg-stone-700 text-white rounded-lg shadow hover:bg-stone-800 transition-colors">Search</button>
              <button id="directory-reset-button" class="w-full sm:w-auto px-6 py-2 bg-gray-200 text-gray-700 rounded-lg shadow hover:bg-gray-300 transition-colors">Reset</button>
              <button class="help-button w-full sm:w-auto px-6 py-2 bg-gray-200 text-gray-700 rounded-lg shadow hover:bg-gray-300 transition-colors" title="Help">Help</button>
            </div>
            <div id="directory-search-status" class="mt-2 text-gray-700 text-center min-h-[1.5rem]"></div>
            <div id="directory-row-count" class="mt-1 text-sm text-center text-gray-600"></div>
            <div id="directory-display-area" class="overflow-x-auto mt-4 table-container">
                <p id="directory-initial-loader" class="text-center text-gray-500 mt-8 text-lg">Loading Directory...</p>
            </div>
        </div>

        <div id="page-faq" class="page">
             <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-4">
                <input id="faq-search-input" type="text" placeholder="Ask a question or search keywords..." class="flex-1 w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-stone-500 focus:outline-none" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="search" />
                <button id="faq-search-button" class="w-full sm:w-auto px-6 py-2 bg-stone-700 text-white rounded-lg shadow hover:bg-stone-800 transition-colors duration-200">Search</button>
                <button id="faq-reset-button" class="w-full sm:w-auto px-6 py-2 bg-gray-200 text-gray-700 rounded-lg shadow hover:bg-gray-300 transition-colors duration-200">Reset</button>
                <button class="help-button w-full sm:w-auto px-6 py-2 bg-gray-200 text-gray-700 rounded-lg shadow hover:bg-gray-300 transition-colors" title="Help">Help</button>
            </div>
            <div id="faq-search-status" class="mt-2 text-gray-700 text-center min-h-[1.5rem]"></div>
            <div id="faq-row-count" class="mt-1 text-sm text-center text-gray-600"></div>
            <div id="faq-display-area" class="overflow-x-auto mt-4 space-y-4">
                <p id="faq-initial-loader" class="text-center text-gray-500 mt-8 text-lg">Loading FAQ...</p>
            </div>
        </div>
        
        <div id="page-employees" class="page">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="employee-page-title" class="text-2xl font-bold text-gray-800">Employee Resources</h2>
                <div id="user-info-container" class="flex items-center gap-3">
                    <button id="login-btn" class="hidden px-5 py-2 bg-stone-700 text-white rounded-lg shadow-md hover:bg-stone-800 transition-all duration-200 text-sm font-medium">
                        Login
                    </button>
                    <div id="user-info" class="hidden flex items-center gap-4 bg-gradient-to-r from-stone-50 to-stone-100 px-5 py-3 rounded-xl border border-stone-200 shadow-sm">
                        <a href="#/employees/profile" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                            <div class="w-10 h-10 bg-stone-700 rounded-full flex items-center justify-center text-white font-bold text-sm" id="user-avatar"></div>
                            <div class="text-left">
                                <div id="user-email" class="text-sm font-semibold text-gray-800"></div>
                                <div id="user-role" class="text-xs text-stone-600 font-medium"></div>
                            </div>
                        </a>
                        <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-sm hover:bg-red-700 transition-all duration-200 text-sm font-medium hover:shadow-md">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="md:col-span-2">
                    <div id="subpage-colophon" class="employee-subpage">
                        <h3 class="font-semibold text-2xl mb-4 text-gray-800 border-b pb-2">The Colophon</h3>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                            <h4 class="font-semibold text-gray-700 mb-2">New Post</h4>
                            <textarea id="colophon-post-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-stone-500 focus:outline-none" rows="3" placeholder="What's on your mind? Found a treasure? Vent about a weird customer..."></textarea>
                            <div class="flex justify-end mt-2">
                                <button id="colophon-post-button" class="px-5 py-2 bg-stone-700 text-white rounded-lg shadow hover:bg-stone-800 transition-colors">Post</button>
                            </div>
                        </div>

                        <div id="colophon-feed-display" class="space-y-6">
                            <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 post-container">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-10 h-10 bg-stone-200 rounded-full flex items-center justify-center font-bold text-stone-600">JK</div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-gray-800">John King (Ghost)</span>
                                            <span class="text-xs text-gray-500">5 minutes ago</span>
                                        </div>
                                        <p class="mt-1 text-gray-700">Found a first edition of *Dune* used as a doorstop on the 3rd floor. The spice must flow... straight to the rare book room. Let me know if you see the culprit.</p>
                                        <div class="mt-3 flex items-center space-x-4">
                                            <button class="reply-button text-sm font-semibold text-gray-600 hover:text-stone-700">Reply</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="replies-container pl-12 mt-4 space-y-4 border-l-2 border-gray-100 ml-1">
                                    <div class="flex items-start space-x-3">
                                        <div class="flex-shrink-0">
                                            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-semibold text-gray-600 text-sm">MB</div>
                                        </div>
                                        <div class="flex-1 bg-gray-50 p-3 rounded-lg">
                                            <div class="flex justify-between items-center">
                                                <span class="font-semibold text-gray-800 text-sm">Mary B.</span>
                                                <span class="text-xs text-gray-400">2 minutes ago</span>
                                            </div>
                                            <p class="mt-1 text-sm text-gray-700">Probably the same person who keeps shelving philosophy books in the metaphysics section. I'm on it.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="reply-form-container pl-12 mt-4 ml-1 hidden">
                                    <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" rows="2" placeholder="Write a reply..."></textarea>
                                    <div class="flex justify-end mt-2 space-x-2">
                                         <button class="cancel-reply-button px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                                        <button class="submit-reply-button px-3 py-1 text-xs bg-stone-600 text-white rounded-md hover:bg-stone-700">Submit Reply</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="subpage-search-admin" class="employee-subpage">
                        <h3 class="font-semibold text-lg mb-4 text-gray-700">Search Analytics</h3>
                        <p class="text-sm text-gray-600 mb-4">View recent search queries from customers and employees.</p>

                        <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-xs text-blue-800">
                                <strong>üí° Note:</strong> Data is cached for 5 minutes to reduce Firebase reads. Click "Refresh Data" to fetch the latest (costs 100 reads). Limit: 100 most recent searches.
                            </p>
                        </div>

                        <div class="mb-4 flex gap-2 items-center flex-wrap">
                            <button id="refresh-searches-btn" class="px-4 py-2 bg-stone-700 text-white rounded-lg shadow hover:bg-stone-800 transition-colors text-sm">Refresh Data</button>
                            <button id="test-firestore-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors text-sm">Test Firestore Connection</button>
                            <span id="search-count" class="text-sm text-gray-600"></span>
                            <span id="cache-indicator" class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded hidden">üì¶ Using cached data</span>
                        </div>

                        <div id="firestore-status" class="mb-4 p-3 bg-gray-50 rounded-lg border text-sm hidden">
                            <strong>Status:</strong> <span id="firestore-status-text"></span>
                        </div>

                        <!-- Filters -->
                        <div class="mb-4 p-4 bg-white rounded-lg shadow-md border border-gray-200">
                            <h4 class="font-semibold text-gray-700 mb-3 text-sm">Filters</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Search Type</label>
                                    <select id="filter-search-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-stone-500 focus:outline-none">
                                        <option value="">All Types</option>
                                        <option value="directory">Directory</option>
                                        <option value="faq">FAQ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Result Count</label>
                                    <select id="filter-result-count" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-stone-500 focus:outline-none">
                                        <option value="">Any</option>
                                        <option value="0">No Results (0)</option>
                                        <option value="1-5">1-5 Results</option>
                                        <option value="6-20">6-20 Results</option>
                                        <option value="21+">21+ Results</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Keyword Search</label>
                                    <input type="text" id="filter-keyword" placeholder="Filter by query text..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-stone-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Date Range</label>
                                    <select id="filter-date-range" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-stone-500 focus:outline-none">
                                        <option value="">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="week">Past Week</option>
                                        <option value="month">Past Month</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button id="apply-filters-btn" class="px-4 py-2 bg-stone-700 text-white rounded-lg shadow hover:bg-stone-800 transition-colors text-sm">Apply Filters</button>
                                <button id="clear-filters-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg shadow hover:bg-gray-300 transition-colors text-sm">Clear</button>
                            </div>
                        </div>

                        <div id="search-admin-display" class="overflow-x-auto">
                            <p class="text-gray-500">Loading search logs...</p>
                        </div>

                        <!-- Pagination -->
                        <div id="pagination-controls" class="hidden mt-4 flex justify-center items-center gap-2">
                            <button id="prev-page-btn" class="px-3 py-1 bg-stone-700 text-white rounded hover:bg-stone-800 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                            <span id="page-info" class="text-sm text-gray-600">Page 1 of 1</span>
                            <button id="next-page-btn" class="px-3 py-1 bg-stone-700 text-white rounded hover:bg-stone-800 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                        </div>
                    </div>

                    <div id="subpage-profile" class="employee-subpage">
                        <h3 class="font-semibold text-2xl mb-4 text-gray-800 border-b pb-2">Profile Settings</h3>

                        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-6">
                            <h4 class="font-semibold text-gray-700 mb-4 text-lg">Account Information</h4>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                    <div class="px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 text-gray-600" id="profile-email-display">Loading...</div>
                                    <p class="text-xs text-gray-500 mt-1">Your email cannot be changed</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Account Role</label>
                                    <div class="px-4 py-2 bg-gray-50 rounded-lg border border-gray-200 text-gray-600" id="profile-role-display">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <h4 class="font-semibold text-gray-700 mb-4 text-lg">Display Settings</h4>

                            <div class="space-y-4">
                                <div>
                                    <label for="display-name-input" class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                                    <input
                                        type="text"
                                        id="display-name-input"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-stone-500 focus:outline-none"
                                        placeholder="Enter your display name"
                                        maxlength="50"
                                    />
                                    <p class="text-xs text-gray-500 mt-1">This name will appear in the Colophon and other areas instead of your email address</p>
                                </div>

                                <div class="flex items-center gap-3">
                                    <button id="save-display-name-btn" class="px-6 py-2 bg-stone-700 text-white rounded-lg shadow hover:bg-stone-800 transition-colors font-medium">
                                        Save Changes
                                    </button>
                                    <span id="save-status" class="text-sm text-gray-600"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <strong>üí° Coming Soon:</strong> More customization options including profile pictures, notification preferences, and more!
                            </p>
                        </div>
                    </div>
                </div>
                <div class="md:col-span-1">
                     <div id="employee-nav" role="navigation" aria-label="Employee navigation">
                      <nav class="vnav">
                        <div class="vnav-title">Employee Menu</div>
                        <ul>
                            <li><a href="#/employees/colophon" data-subpage="colophon">üìù The Colophon</a></li>
                            <li><a href="https://book-scanner-jkk.web.app/" target="_blank" rel="noopener noreferrer">üì∑ Book Baby Book Scanner</a></li>
                            <li><a href="#/employees/search-admin" data-subpage="search-admin">üìä Search Analytics</a></li>
                            <li><a href="#/employees/profile" data-subpage="profile">üë§ Profile Settings</a></li>
                        </ul>
                      </nav>
                    </div>
                </div>
            </div>
        </div>
    </main>
  </div>

  <div id="info-panel" class="fixed top-0 right-0 h-full w-0 overflow-hidden bg-white border-l border-gray-300 shadow-lg transition-all duration-300 ease-in-out z-50">
    <div class="h-full flex flex-col">
      <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-100">
        <h3 class="text-lg font-semibold text-gray-700">Store Info</h3>
        <button id="close-panel" class="text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
      </div>
      <div id="info-panel-content" class="p-4 overflow-y-auto text-sm text-gray-700 space-y-4">
        <p><strong>Welcome to John K. King Used & Rare Books!</strong></p>
        <ul class="space-y-3">
          <li><div class="flex items-start"><span class="mr-3 text-xl">üïê</span><div><b class="text-gray-800">Store Hours:</b><p class="pl-1 text-gray-600">Mon: 11:00 AM ‚Äì 4:00 PM<br>Tues‚ÄìSat: 9:30 AM ‚Äì 5:30 PM<br>Sun: Closed</p></div></div></li>
          <li><div class="flex items-start"><span class="mr-3 text-xl">üìç</span><div><b class="text-gray-800">Address:</b><p class="pl-1 text-gray-600">901 W. Lafayette Blvd<br>Detroit, MI 48226</p></div></div></li>
          <li><div class="flex items-start"><span class="mr-3 text-xl">üìû</span><div><b class="text-gray-800">Phone:</b><p class="pl-1 text-gray-600">(313) 961-0622</p></div></div></li>
          <li><div class="flex items-start"><span class="mr-3 text-xl">üó∫Ô∏è</span><div><b class="text-gray-800">Store Maps:</b><span class="text-gray-600"> Available at the front counter.</span></div></div></li>
          <li><div class="flex items-start"><span class="mr-3 text-xl">üìö</span><div><b class="text-gray-800">Staff Assistance:</b><span class="text-gray-600"> Look for staff in tan or red aprons.</span></div></div></li>
          <li><div class="flex items-start"><span class="mr-3 text-xl">‚òéÔ∏è</span><div><b class="text-gray-800">Need Help?</b><span class="text-gray-600"> Use phones on each floor and dial 105.</span></div></div></li>
          <li><div class="flex items-start"><span class="mr-3 text-xl">üõó</span><div><b class="text-gray-800">Accessibility:</b><span class="text-gray-600"> Freight elevator available upon request.</span></div></div></li>
          <li><div class="flex items-start"><span class="mr-3 text-xl">üöª</span><div><b class="text-gray-800">Restrooms:</b><span class="text-gray-600"> Located on the 2nd floor. A key is required.</span></div></div></li>
        </ul>
        <div class="mt-6 pt-4 border-t">
          <p class="font-semibold mb-2 text-gray-800">Tap to view store map:</p>
          <img src="https://i.imgur.com/pUfm5We.png" alt="Store Map Thumbnail" id="store-map-thumbnail" class="cursor-pointer rounded-md shadow-md w-full hover:shadow-lg transition-shadow"/>
        </div>
      </div>
    </div>
  </div>

  <div id="fullscreen-map"><div id="fullscreen-map-close" title="Close Map">&times;</div><div id="zoom-container"><img src="https://i.imgur.com/pUfm5We.png" alt="Fullscreen Store Map" /></div></div>
  <div id="help-modal-overlay">
      <div id="help-modal">
          <button id="close-help-modal" class="absolute text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
          <h2 class="text-2xl font-bold text-gray-800 mb-4">üìñ Directory Key</h2>
          <p class="mb-4 text-xs text-gray-600 bg-gray-50 p-3 rounded-md border">üö´ We do not catalog individual books.üö´ This is a Subject Directory meant to aid you in finding your subject section of choice. If we are missing a subject that you think should be included, please suggest it below, and we will add it to our ever growing list.</p>
          <div class="mb-4 flex justify-center gap-6">
            <a href="#/directory" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold" id="back-to-directory-link">‚Üê Back to Directory</a>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSfbHuDXDbKlq85_eDGzYY6xtzqNEXCi7pUlR2I5C0t2EawzIA/viewform" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline font-semibold">Leave a Suggestion ‚Üí</a>
          </div>
          <div class="space-y-3 text-gray-700">  
            <p> üìï <strong>Aisle:</strong> Each aisle is labeled with a number (or letter) for identification. Look for aisle numbers on the side-ends of every shelf. </p>
            <p> üìó <strong>Case:</strong> A single column in a range of shelves is a Case. For example, Dance materials are in Case B, the column to the right of the glass display case on Floor 1. </p>
            <p> üìò <strong> Glass Case:</strong> Glass Cases are display cases with glass doors, usually locked. Please find staff for assistance. </p>  
            <p> üìô <strong>E.C.:</strong> Endcap.</p> <p> üìî <strong>P.B.:</strong> Paperback.</p> <p> üìö <strong>H.C.:</strong> Hardcover.</p>    
            <p> üìñ <strong>Center:</strong> The Center Aisle is the aisle that spans the length of the building, bisecting the floor into East and West sides.</p>
            <p> üìö <strong>Front, Rear:</strong> Refers to the opposing ends of the building. The stairwell is at the Front, while the elevator is at the Rear.</p>     
            <p> üß≠ <strong>East:</strong> Parkinglot side of the building.</p> <p> üß≠ <strong>West:</strong> 5th Street side of the building.</p>
            <p>üö™<strong>Room:</strong> The 1st Floor is divided into Rooms: Rooms 1, 2A. 2B, 3A, 3B, 3C, and 4.</p>
          </div>
      </div>
  </div>
  
  <div id="feedback-modal-overlay">
    <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl h-[90vh] relative flex flex-col p-4 md:p-6">
      <button id="close-feedback-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl font-bold z-10">&times;</button>
      <h2 class="text-2xl font-bold text-gray-800 mb-4 flex-shrink-0">Customer Feedback</h2>
      <div class="flex-grow w-full h-full -mx-4 -mb-4 md:-mx-6 md:-mb-6">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSfQj5V6tegD4_STXd-4TFlRuA7a8PbyAgoy1zGayhjbpnqx4w/viewform?embedded=true" class="w-full h-full border-0 rounded-b-lg" frameborder="0" marginheight="0" marginwidth="0">Loading‚Ä¶</iframe>
      </div>
    </div>
  </div>

  <div id="suggestion-modal-overlay">
    <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl h-[90vh] relative flex flex-col p-4 md:p-6">
      <button id="close-suggestion-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl font-bold z-10">&times;</button>
      <h2 class="text-2xl font-bold text-gray-800 mb-4 flex-shrink-0">Suggest a Search Term</h2>
      <div class="flex-grow w-full h-full -mx-4 -mb-4 md:-mx-6 md:-mb-6">
        <iframe id="suggestion-iframe" src="" class="w-full h-full border-0 rounded-b-lg" frameborder="0" marginheight="0" marginwidth="0">Loading‚Ä¶</iframe>
      </div>
    </div>
  </div>
  
  <button id="open-panel" class="fixed bg-stone-700 text-white px-2 py-6 rounded-l-lg shadow-lg hover:bg-stone-800 z-40">Store<br>Info</button>
  <button id="back-to-top" class="fixed bg-stone-700 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-stone-800" title="Back to Top">‚Üë</button>

  <!-- Persistent Employee Navigation Panel -->
  <div id="persistent-employee-panel" class="hidden fixed bottom-4 right-4 z-50">
    <!-- Minimized State -->
    <div id="panel-minimized" class="bg-gradient-to-br from-stone-800 to-stone-900 text-white rounded-full shadow-2xl border-2 border-stone-600 cursor-pointer hover:scale-110 transition-transform duration-200">
      <div class="w-14 h-14 flex items-center justify-center font-bold text-lg" id="minimized-avatar"></div>
    </div>

    <!-- Expanded State -->
    <div id="panel-expanded" class="hidden bg-gradient-to-br from-stone-800 to-stone-900 text-white rounded-xl shadow-2xl p-4 border border-stone-700" style="min-width: 280px;">
      <div class="flex flex-col gap-3">
        <div class="flex items-center gap-3 pb-3 border-b border-stone-600">
          <a href="#/employees/profile" class="flex items-center gap-3 flex-1 min-w-0 hover:opacity-80 transition-opacity">
            <div class="w-10 h-10 bg-stone-600 rounded-full flex items-center justify-center font-bold text-sm" id="persistent-user-avatar"></div>
            <div class="flex-1 min-w-0">
              <div id="persistent-user-email" class="text-sm font-semibold truncate"></div>
              <div id="persistent-user-role" class="text-xs text-stone-300"></div>
            </div>
          </a>
          <button id="minimize-panel-btn" class="text-stone-400 hover:text-white transition-colors text-xl leading-none flex-shrink-0" title="Minimize">‚àí</button>
        </div>
        <a href="#/employees" class="flex items-center gap-2 px-4 py-2 bg-stone-700 hover:bg-stone-600 rounded-lg transition-colors text-center justify-center text-sm font-medium">
          <span>üìã</span>
          <span>Employee Pages</span>
        </a>
        <button id="persistent-logout-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors text-sm font-medium">
          Logout
        </button>
      </div>
    </div>
  </div>
<div id="auth-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(4px);">
  <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm relative">
    <button id="close-auth-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl font-bold z-10">&times;</button>
    <h2 class="text-xl font-bold text-gray-800 mb-4">Employee Access</h2>
    <p class="text-gray-600 mb-4 text-sm">Sign in or create an account to access employee resources.</p>
    <input type="email" id="auth-email-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-stone-500 focus:outline-none mb-3" placeholder="Email">
    <input type="password" id="auth-password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-stone-500 focus:outline-none" placeholder="Password">
    <p id="auth-error" class="text-red-500 text-xs mt-2 h-4"></p>
    <div class="flex gap-2 mt-2">
      <button id="auth-login-btn" class="flex-1 px-6 py-2 bg-stone-700 text-white rounded-lg shadow hover:bg-stone-800 transition-colors">Log In</button>
      <button id="auth-create-btn" class="flex-1 px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">Create Account</button>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Constants and State ---
  const DIRECTORY_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2iABeNRjSNn_F__Dcd4SAJWYwno0ajUk9tyRf9WmY240V28Q3jZMxW6NBpZWNtc0visIoj128Kc__/pub?gid=0&single=true&output=csv';
  const FAQ_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT_rXkbRD1rRq3Fb08uX5fboYgmbqWWKKNB9poXgu1Bv1wHklLmz67_PcEvcTpkBPKfyjq3VIYy32Rl/pub?output=csv';
  const SUGGESTION_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfbHuDXDbKlq85_eDGzYY6xtzqNEXCi7pUlR2I5C0t2EawzIA/viewform?usp=pp_url&entry.1668158033='; 

  let directoryData = [], faqData = [];
  let directoryFuse, faqFuse;
  let isDirectoryInitialized = false, isFaqInitialized = false;
  let isPanelMinimized = localStorage.getItem('employeePanelMinimized') === 'true';
  let currentUserDisplayName = '';

  // Search Analytics State
  let allSearches = [];
  let filteredSearches = [];
  let currentPage = 1;
  const searchesPerPage = 25;
  let analyticsCache = null;
  let analyticsCacheTime = null;
  const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

  const elements = {
    pages: document.querySelectorAll('.page'),
    navLinks: document.querySelectorAll('.nav-link'),
    dirSearchInput: document.getElementById('directory-search-input'),
    dirSearchButton: document.getElementById('directory-search-button'),
    dirResetButton: document.getElementById('directory-reset-button'),
    dirFloorFilter: document.getElementById('floor-filter'),
    dirDisplayArea: document.getElementById('directory-display-area'),
    dirStatus: document.getElementById('directory-search-status'),
    dirRowCount: document.getElementById('directory-row-count'),
    dirInitialLoader: document.getElementById('directory-initial-loader'),
    faqSearchInput: document.getElementById('faq-search-input'),
    faqSearchButton: document.getElementById('faq-search-button'),
    faqResetButton: document.getElementById('faq-reset-button'),
    faqDisplayArea: document.getElementById('faq-display-area'),
    faqStatus: document.getElementById('faq-search-status'),
    faqRowCount: document.getElementById('faq-row-count'),
    faqInitialLoader: document.getElementById('faq-initial-loader'),
    employeeNavLinks: document.querySelectorAll('#employee-nav a'),
    employeeSubpages: document.querySelectorAll('.employee-subpage'),
    employeePageTitle: document.getElementById('employee-page-title'),
    infoPanel: document.getElementById('info-panel'),
    closePanelBtn: document.getElementById('close-panel'),
    openPanelBtn: document.getElementById('open-panel'),
    fullscreenMap: document.getElementById('fullscreen-map'),
    fullscreenClose: document.getElementById('fullscreen-map-close'),
    storeMapThumbnail: document.getElementById('store-map-thumbnail'),
    backToTopBtn: document.getElementById('back-to-top'),
    helpModalOverlay: document.getElementById('help-modal-overlay'),
    closeHelpModal: document.getElementById('close-help-modal'),
    feedbackLink: document.getElementById('feedback-link'),
    feedbackModalOverlay: document.getElementById('feedback-modal-overlay'),
    closeFeedbackModal: document.getElementById('close-feedback-modal'),
    suggestionModalOverlay: document.getElementById('suggestion-modal-overlay'),
    closeSuggestionModal: document.getElementById('close-suggestion-modal'),
    suggestionIframe: document.getElementById('suggestion-iframe'),
    authModalOverlay: document.getElementById('auth-modal-overlay'),
    authEmailInput: document.getElementById('auth-email-input'),
    authPasswordInput: document.getElementById('auth-password-input'),
    authLoginBtn: document.getElementById('auth-login-btn'),
    authCreateBtn: document.getElementById('auth-create-btn'),
    authError: document.getElementById('auth-error'),
    closeAuthModal: document.getElementById('close-auth-modal'),
    loginBtn: document.getElementById('login-btn'),
    logoutBtn: document.getElementById('logout-btn'),
    userInfo: document.getElementById('user-info'),
    userEmail: document.getElementById('user-email'),
    userRole: document.getElementById('user-role'),
    userAvatar: document.getElementById('user-avatar'),
    colophonPostInput: document.getElementById('colophon-post-input'),
    colophonPostButton: document.getElementById('colophon-post-button'),
    colophonFeedDisplay: document.getElementById('colophon-feed-display'),
    refreshSearchesBtn: document.getElementById('refresh-searches-btn'),
    searchAdminDisplay: document.getElementById('search-admin-display'),
    searchCount: document.getElementById('search-count'),
    testFirestoreBtn: document.getElementById('test-firestore-btn'),
    firestoreStatus: document.getElementById('firestore-status'),
    firestoreStatusText: document.getElementById('firestore-status-text'),
    persistentEmployeePanel: document.getElementById('persistent-employee-panel'),
    persistentUserEmail: document.getElementById('persistent-user-email'),
    persistentUserRole: document.getElementById('persistent-user-role'),
    persistentUserAvatar: document.getElementById('persistent-user-avatar'),
    persistentLogoutBtn: document.getElementById('persistent-logout-btn'),
    panelMinimized: document.getElementById('panel-minimized'),
    panelExpanded: document.getElementById('panel-expanded'),
    minimizedAvatar: document.getElementById('minimized-avatar'),
    minimizePanelBtn: document.getElementById('minimize-panel-btn'),
    profileEmailDisplay: document.getElementById('profile-email-display'),
    profileRoleDisplay: document.getElementById('profile-role-display'),
    displayNameInput: document.getElementById('display-name-input'),
    saveDisplayNameBtn: document.getElementById('save-display-name-btn'),
    saveStatus: document.getElementById('save-status'),
    filterSearchType: document.getElementById('filter-search-type'),
    filterResultCount: document.getElementById('filter-result-count'),
    filterKeyword: document.getElementById('filter-keyword'),
    filterDateRange: document.getElementById('filter-date-range'),
    applyFiltersBtn: document.getElementById('apply-filters-btn'),
    clearFiltersBtn: document.getElementById('clear-filters-btn'),
    paginationControls: document.getElementById('pagination-controls'),
    prevPageBtn: document.getElementById('prev-page-btn'),
    nextPageBtn: document.getElementById('next-page-btn'),
    pageInfo: document.getElementById('page-info'),
    cacheIndicator: document.getElementById('cache-indicator'),
  };
  
  // --- Colophon Functionality ---
  function createPostElement(text, author = "Current User", initials = "CU") {
    const postHTML = `
      <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200 post-container">
          <div class="flex items-start space-x-3">
              <div class="flex-shrink-0">
                  <div class="w-10 h-10 bg-stone-200 rounded-full flex items-center justify-center font-bold text-stone-600">${initials}</div>
              </div>
              <div class="flex-1">
                  <div class="flex justify-between items-center">
                      <span class="font-bold text-gray-800">${author}</span>
                      <span class="text-xs text-gray-500">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                  </div>
                  <p class="mt-1 text-gray-700">${text}</p>
                  <div class="mt-3 flex items-center space-x-4">
                      <button class="reply-button text-sm font-semibold text-gray-600 hover:text-stone-700">Reply</button>
                  </div>
              </div>
          </div>
          <div class="replies-container pl-12 mt-4 space-y-4 border-l-2 border-gray-100 ml-1"></div>
          <div class="reply-form-container pl-12 mt-4 ml-1 hidden">
              <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" rows="2" placeholder="Write a reply..."></textarea>
              <div class="flex justify-end mt-2 space-x-2">
                   <button class="cancel-reply-button px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                  <button class="submit-reply-button px-3 py-1 text-xs bg-stone-600 text-white rounded-md hover:bg-stone-700">Submit Reply</button>
              </div>
          </div>
      </div>`;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = postHTML.trim();
    return tempDiv.firstChild;
  }

  function createReplyElement(text, author = "Current User", initials = "CU") {
      const replyHTML = `
      <div class="flex items-start space-x-3">
          <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-semibold text-gray-600 text-sm">${initials}</div>
          </div>
          <div class="flex-1 bg-gray-50 p-3 rounded-lg">
              <div class="flex justify-between items-center">
                  <span class="font-semibold text-gray-800 text-sm">${author}</span>
                  <span class="text-xs text-gray-400">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
              </div>
              <p class="mt-1 text-sm text-gray-700">${text}</p>
          </div>
      </div>`;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = replyHTML.trim();
      return tempDiv.firstChild;
  }
  
  if (elements.colophonPostButton) {
      elements.colophonPostButton.addEventListener('click', () => {
          const postText = elements.colophonPostInput.value.trim();
          if (postText) {
              const user = window.firebaseAuth?.currentUser;
              const displayName = currentUserDisplayName || user?.email || 'Current User';
              const email = user?.email || '';
              const initials = displayName.slice(0, 2).toUpperCase();
              const newPost = createPostElement(postText, displayName, initials);
              elements.colophonFeedDisplay.prepend(newPost);
              elements.colophonPostInput.value = '';
          }
      });
  }

  if (elements.colophonFeedDisplay) {
      elements.colophonFeedDisplay.addEventListener('click', (e) => {
          const target = e.target;
          const postContainer = target.closest('.post-container');
          if (!postContainer) return;

          const replyFormContainer = postContainer.querySelector('.reply-form-container');
          
          if (target.classList.contains('reply-button')) {
              replyFormContainer.classList.toggle('hidden');
              if (!replyFormContainer.classList.contains('hidden')) {
                  replyFormContainer.querySelector('textarea').focus();
              }
          }
          
          if (target.classList.contains('cancel-reply-button')) {
              replyFormContainer.classList.add('hidden');
              replyFormContainer.querySelector('textarea').value = '';
          }

          if (target.classList.contains('submit-reply-button')) {
              const replyTextarea = replyFormContainer.querySelector('textarea');
              const replyText = replyTextarea.value.trim();
              if (replyText) {
                  const user = window.firebaseAuth?.currentUser;
                  const displayName = currentUserDisplayName || user?.email || 'Current User';
                  const initials = displayName.slice(0, 2).toUpperCase();
                  const newReply = createReplyElement(replyText, displayName, initials);
                  postContainer.querySelector('.replies-container').appendChild(newReply);
                  replyTextarea.value = '';
                  replyFormContainer.classList.add('hidden');
              }
          }
      });
  }
  
  if (elements.colophonPostInput) {
    elements.colophonPostInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        elements.colophonPostButton.click();
      }
    });
  }

  if (elements.colophonFeedDisplay) {
    elements.colophonFeedDisplay.addEventListener('keydown', (event) => {
      if (event.target.tagName === 'TEXTAREA' && event.target.closest('.reply-form-container')) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          const replyContainer = event.target.closest('.reply-form-container');
          replyContainer.querySelector('.submit-reply-button').click();
        }
      }
    });
  }

  function isAuthenticated() {
    // Check if Firebase Auth is ready and user is logged in
    return window.firebaseAuth && window.firebaseAuth.currentUser !== null;
  }

  // Toggle between minimized and expanded panel states
  function togglePanel() {
    isPanelMinimized = !isPanelMinimized;
    localStorage.setItem('employeePanelMinimized', isPanelMinimized);
    updatePanelState();
  }

  function updatePanelState() {
    if (isPanelMinimized) {
      elements.panelExpanded.classList.add('hidden');
      elements.panelMinimized.classList.remove('hidden');
      elements.backToTopBtn.classList.remove('with-employee-panel');
      elements.backToTopBtn.classList.add('with-employee-panel-minimized');
    } else {
      elements.panelMinimized.classList.add('hidden');
      elements.panelExpanded.classList.remove('hidden');
      elements.backToTopBtn.classList.remove('with-employee-panel-minimized');
      elements.backToTopBtn.classList.add('with-employee-panel');
    }
  }

  async function getUserRole() {
    // Get user role from Firestore
    if (!isAuthenticated() || !window.getUserRole) {
      return null;
    }
    return await window.getUserRole();
  }

  function parseCSV(csvText) {
    const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
    if (lines.length < 2) return [];
    const headers = lines[0].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(h => h.trim().replace(/^"|"$/g, ''));
    return lines.slice(1).map(line => {
      const values = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v => v?.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
      return headers.reduce((obj, header, i) => { (obj[header] = values[i] || ''); return obj; }, {});
    });
  }

  function handleRouteChange() {
    const hash = window.location.hash.replace('#/', '');
    const [pageId, subpageId] = hash.split('/');
    const targetPage = pageId || 'directory';

    if (targetPage === 'employees' && !isAuthenticated()) {
      elements.pages.forEach(page => page.classList.remove('active'));
      elements.authModalOverlay.style.display = 'flex';
      elements.authEmailInput.focus();
      return;
    }

    elements.authModalOverlay.style.display = 'none';
    elements.pages.forEach(page => page.classList.remove('active'));
    const activePage = document.getElementById(`page-${targetPage}`);
    if (activePage) activePage.classList.add('active');
    else document.getElementById('page-directory').classList.add('active');
    elements.navLinks.forEach(link => link.classList.toggle('active', link.dataset.page === targetPage));

    if (targetPage === 'directory' && !isDirectoryInitialized) initializeDirectoryPage();
    else if (targetPage === 'faq' && !isFaqInitialized) initializeFaqPage();
    else if (targetPage === 'employees') handleEmployeeSubpage(subpageId || 'colophon');
  }

  async function handleEmployeeSubpage(subpageId) {
    // Default to 'colophon' if no subpage specified
    const targetSubpage = subpageId || 'colophon';

    // Check admin access for search-admin subpage
    if (targetSubpage === 'search-admin') {
      const role = await getUserRole();
      if (role !== 'admin') {
        alert('Access denied. This page is only accessible to administrators.');
        window.location.hash = '#/employees/colophon';
        return;
      }
    }

    // Update page title
    const activeLink = document.querySelector(`#employee-nav a[data-subpage="${targetSubpage}"]`);
    if (activeLink && elements.employeePageTitle) {
        elements.employeePageTitle.textContent = activeLink.textContent.trim();
    }

    // Activate the target subpage
    elements.employeeSubpages.forEach(subpage => subpage.classList.remove('active'));
    const activeSubpage = document.getElementById(`subpage-${targetSubpage}`);
    if (activeSubpage) {
      activeSubpage.classList.add('active');
    } else {
      // Fallback to colophon if subpage not found
      document.getElementById('subpage-colophon').classList.add('active');
    }

    // Highlight active navigation link
    elements.employeeNavLinks.forEach(link => link.classList.toggle('active', link.dataset.subpage === targetSubpage));

    // Load analytics if on search-admin page
    if (targetSubpage === 'search-admin') loadSearchAnalytics();

    // Load profile if on profile page
    if (targetSubpage === 'profile') loadProfilePage();
  }

  async function loadProfilePage() {
    const user = window.firebaseAuth?.currentUser;
    if (!user) return;

    // Display email and role
    elements.profileEmailDisplay.textContent = user.email;
    const role = await getUserRole();
    const roleDisplay = role === 'admin' ? 'üëë Admin' : 'üë§ Employee';
    elements.profileRoleDisplay.textContent = roleDisplay;

    // Load display name from Firestore
    if (window.getUserDisplayName) {
      const displayName = await window.getUserDisplayName();
      elements.displayNameInput.value = displayName || '';
    }
  }

  async function saveDisplayName() {
    const displayName = elements.displayNameInput.value.trim();

    if (!displayName) {
      elements.saveStatus.textContent = '‚ùå Display name cannot be empty';
      elements.saveStatus.className = 'text-sm text-red-600';
      setTimeout(() => { elements.saveStatus.textContent = ''; }, 3000);
      return;
    }

    if (!window.setUserDisplayName) {
      elements.saveStatus.textContent = '‚ùå Firebase not ready';
      elements.saveStatus.className = 'text-sm text-red-600';
      return;
    }

    try {
      elements.saveStatus.textContent = '‚è≥ Saving...';
      elements.saveStatus.className = 'text-sm text-blue-600';

      await window.setUserDisplayName(displayName);
      currentUserDisplayName = displayName;

      elements.saveStatus.textContent = '‚úÖ Saved successfully!';
      elements.saveStatus.className = 'text-sm text-green-600';

      // Update all UI elements with new display name
      await updateUserInfoDisplay(window.firebaseAuth.currentUser);

      setTimeout(() => { elements.saveStatus.textContent = ''; }, 3000);
    } catch (error) {
      console.error('Error saving display name:', error);
      elements.saveStatus.textContent = '‚ùå Failed to save';
      elements.saveStatus.className = 'text-sm text-red-600';
      setTimeout(() => { elements.saveStatus.textContent = ''; }, 3000);
    }
  }

  function populateFloorFilter() {
    if (!directoryData || directoryData.length === 0) return;
    const floors = [...new Set(directoryData.map(item => item['FLOOR']))].filter(Boolean).sort((a, b) => a - b);
    floors.forEach(floor => {
        const option = document.createElement('option');
        option.value = floor;
        option.textContent = `Floor ${floor}`;
        elements.dirFloorFilter.appendChild(option);
    });
  }

  async function initializeDirectoryPage() {
    isDirectoryInitialized = true;
    try {
        const response = await fetch(DIRECTORY_CSV_URL);
        const text = await response.text();
        directoryData = parseCSV(text);
        directoryFuse = new Fuse(directoryData, { keys: Object.keys(directoryData[0] || {}), threshold: 0.4, ignoreLocation: true });
        populateFloorFilter();
        renderDirectoryTable(directoryData);
        elements.dirRowCount.textContent = `Showing all ${directoryData.length} entries.`;
    } catch (e) { console.error("Directory Init Error", e); }
  }

  async function initializeFaqPage() {
    isFaqInitialized = true;
     try {
        const response = await fetch(FAQ_CSV_URL);
        const text = await response.text();
        faqData = parseCSV(text);
        faqFuse = new Fuse(faqData, { keys: [{ name: 'Question', weight: 0.6 }, { name: 'Answer', weight: 0.3 }, { name: 'Keywords', weight: 0.5 }], threshold: 0.4, ignoreLocation: true });
        renderFaqCards(faqData);
        elements.faqRowCount.textContent = `Showing all ${faqData.length} questions.`;
    } catch (e) { console.error("FAQ Init Error", e); }
  }

  
  function renderDirectoryTable(data, query = '') {
    if (elements.dirInitialLoader) elements.dirInitialLoader.style.display = 'none';
    if (!data || data.length === 0) {
        if (query) {
            elements.dirDisplayArea.innerHTML = `
                <div class="text-center text-gray-600 mt-8 p-6 bg-gray-50 rounded-lg border">
                    <p class="text-lg mb-2">No results found for "<strong>${query}</strong>".</p>
                    <p class="text-sm mb-4">Would you like us to consider adding this term to the directory?</p>
                    <button id="open-suggestion-btn" data-term="${query}" class="inline-block bg-stone-700 text-white px-5 py-2 rounded-lg shadow hover:bg-stone-800 transition-colors">
                        Suggest adding "${query}"
                    </button>
                </div>`;
        } else {
            elements.dirDisplayArea.innerHTML = `<p class="text-center text-gray-500 mt-8 text-lg">No results found.</p>`;
        }
        return;
    }
    const headers = Object.keys(data[0] || {}).filter(h => h.toUpperCase() !== 'KEYWORDS');
    let tableHTML = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
    data.forEach(row => { tableHTML += `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`; });
    elements.dirDisplayArea.innerHTML = tableHTML + '</tbody></table>';
  }

  function renderFaqCards(data, query = '') {
    if (elements.faqInitialLoader) elements.faqInitialLoader.style.display = 'none';
    if (!data || data.length === 0) {
        if (query) {
            elements.faqDisplayArea.innerHTML = `
                <div class="text-center text-gray-600 mt-8 p-6 bg-gray-50 rounded-lg border">
                    <p class="text-lg mb-2">No results found for "<strong>${query}</strong>".</p>
                    <p class="text-sm mb-4">Would you like to suggest this as a new question for our FAQ?</p>
                    <button id="open-suggestion-btn" data-term="${query}" class="inline-block bg-stone-700 text-white px-5 py-2 rounded-lg shadow hover:bg-stone-800 transition-colors">
                        Suggest adding "${query}"
                    </button>
                </div>`;
        } else {
            elements.faqDisplayArea.innerHTML = `<p class="text-center text-gray-500 mt-8 text-lg">No results found.</p>`;
        }
        return;
    }
    let cardHTML = '<div class="space-y-4">';
    data.forEach((entry) => {
        const question = entry['Question'] || 'No Question', answer = entry['Answer'] || 'No Answer.', category = entry['Category'] || '';
        cardHTML += `<div class="faq-card"><div class="faq-question"><div>‚ùì ${question}</div><span class="faq-toggle-icon">‚ñº</span></div><div class="faq-answer"><p>${answer.replace(/\n/g, '<br>')}</p>${category ? `<div class="mt-4 text-xs font-medium bg-stone-100 text-stone-600 px-2 py-1 rounded-full inline-block">Category: ${category}</div>` : ''}</div></div>`;
    });
    elements.faqDisplayArea.innerHTML = cardHTML + '</div>';
    document.querySelectorAll('.faq-question').forEach(qDiv => {
        qDiv.addEventListener('click', () => {
            qDiv.nextElementSibling.classList.toggle('expanded');
            qDiv.querySelector('.faq-toggle-icon').classList.toggle('rotated');
        });
    });
  }

  // --- Search Analytics Admin Page ---
  async function testFirestoreConnection() {
    if (!elements.firestoreStatus || !elements.firestoreStatusText) return;

    elements.firestoreStatus.classList.remove('hidden');
    elements.firestoreStatusText.textContent = 'Testing...';
    elements.firestoreStatusText.className = 'text-blue-600';

    console.log('Testing Firestore connection...');

    // Check if Firebase is loaded
    if (!window.firebaseReady) {
      elements.firestoreStatusText.textContent = 'Firebase module not loaded yet. Please wait a moment and try again.';
      elements.firestoreStatusText.className = 'text-orange-600';
      console.error('Firebase not ready');
      return;
    }

    if (!window.logSearchQuery) {
      elements.firestoreStatusText.textContent = 'Error: logSearchQuery function not found.';
      elements.firestoreStatusText.className = 'text-red-600';
      console.error('logSearchQuery function not available');
      return;
    }

    // Try to write a test document
    try {
      console.log('Attempting to write test document...');
      await window.logSearchQuery('test', 'Connection Test', 0);
      elements.firestoreStatusText.textContent = 'Success! Firestore is connected and working. Check the console for details.';
      elements.firestoreStatusText.className = 'text-green-600';
      console.log('Test write successful!');
    } catch (error) {
      elements.firestoreStatusText.textContent = `Error: ${error.message}. Check console for details.`;
      elements.firestoreStatusText.className = 'text-red-600';
      console.error('Test write failed:', error);
    }
  }

  async function loadSearchAnalytics(forceRefresh = false) {
    if (!elements.searchAdminDisplay) return;

    // TEMPORARILY DISABLED TO PREVENT FIREBASE READ COSTS
    elements.searchAdminDisplay.innerHTML = `
      <div class="p-6 bg-yellow-50 border border-yellow-300 rounded-lg">
        <h4 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Analytics Temporarily Disabled</h4>
        <p class="text-yellow-700 text-sm">
          Search analytics has been disabled to prevent excessive Firebase reads and costs.
          If you need to re-enable it, please contact the developer.
        </p>
      </div>
    `;
    console.warn('Search Analytics has been temporarily disabled to prevent Firebase read costs');
    return;

    // ORIGINAL CODE COMMENTED OUT BELOW - DO NOT UNCOMMENT WITHOUT FIXING READ ISSUE
    /*
    // Check cache first (unless force refresh)
    const now = Date.now();
    if (!forceRefresh && analyticsCache && analyticsCacheTime && (now - analyticsCacheTime < CACHE_DURATION)) {
      console.log('Using cached analytics data');
      allSearches = analyticsCache;
      filteredSearches = [...allSearches];
      currentPage = 1;

      // Show cache indicator
      if (elements.cacheIndicator) {
        elements.cacheIndicator.classList.remove('hidden');
      }

      applyFilters();
      return;
    }

    // Hide cache indicator when loading fresh data
    if (elements.cacheIndicator) {
      elements.cacheIndicator.classList.add('hidden');
    }

    elements.searchAdminDisplay.innerHTML = '<p class="text-gray-500">Loading search logs...</p>';

    if (!window.fetchRecentSearches) {
      elements.searchAdminDisplay.innerHTML = '<p class="text-red-500">Error: Firestore not initialized. Try clicking "Test Firestore Connection" button.</p>';
      return;
    }

    try {
      // Reduced from 500 to 100 to minimize reads
      allSearches = await window.fetchRecentSearches(100);

      // Cache the results
      analyticsCache = allSearches;
      analyticsCacheTime = Date.now();

      filteredSearches = [...allSearches];
      currentPage = 1;

      applyFilters();
      console.log(`Loaded ${allSearches.length} searches from Firestore (will cache for 5 minutes)`);
    } catch (error) {
      console.error('Error loading search analytics:', error);
      elements.searchAdminDisplay.innerHTML = '<p class="text-red-500">Error loading search logs. See console for details.</p>';
    }
    */
  }

  function applyFilters() {
    const searchType = elements.filterSearchType?.value || '';
    const resultCount = elements.filterResultCount?.value || '';
    const keyword = elements.filterKeyword?.value.toLowerCase().trim() || '';
    const dateRange = elements.filterDateRange?.value || '';

    filteredSearches = allSearches.filter(search => {
      // Filter by search type
      if (searchType && search.searchType !== searchType) return false;

      // Filter by result count
      if (resultCount) {
        if (resultCount === '0' && search.resultCount !== 0) return false;
        if (resultCount === '1-5' && (search.resultCount < 1 || search.resultCount > 5)) return false;
        if (resultCount === '6-20' && (search.resultCount < 6 || search.resultCount > 20)) return false;
        if (resultCount === '21+' && search.resultCount < 21) return false;
      }

      // Filter by keyword
      if (keyword && !search.query.toLowerCase().includes(keyword)) return false;

      // Filter by date range
      if (dateRange) {
        const timestamp = search.timestamp?.toDate ? search.timestamp.toDate() : new Date(search.timestamp);
        const now = new Date();
        const dayMs = 24 * 60 * 60 * 1000;

        if (dateRange === 'today') {
          const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          if (timestamp < startOfDay) return false;
        } else if (dateRange === 'week') {
          const weekAgo = new Date(now.getTime() - 7 * dayMs);
          if (timestamp < weekAgo) return false;
        } else if (dateRange === 'month') {
          const monthAgo = new Date(now.getTime() - 30 * dayMs);
          if (timestamp < monthAgo) return false;
        }
      }

      return true;
    });

    currentPage = 1;
    renderSearchTable();
  }

  function clearFilters() {
    if (elements.filterSearchType) elements.filterSearchType.value = '';
    if (elements.filterResultCount) elements.filterResultCount.value = '';
    if (elements.filterKeyword) elements.filterKeyword.value = '';
    if (elements.filterDateRange) elements.filterDateRange.value = '';

    filteredSearches = [...allSearches];
    currentPage = 1;
    renderSearchTable();
  }

  function renderSearchTable() {
    if (filteredSearches.length === 0) {
      elements.searchAdminDisplay.innerHTML = '<p class="text-gray-500">No search queries match the current filters.</p>';
      elements.searchCount.textContent = '0 searches match';
      elements.paginationControls?.classList.add('hidden');
      return;
    }

    const totalPages = Math.ceil(filteredSearches.length / searchesPerPage);
    const startIndex = (currentPage - 1) * searchesPerPage;
    const endIndex = startIndex + searchesPerPage;
    const pageSearches = filteredSearches.slice(startIndex, endIndex);

    elements.searchCount.textContent = `${filteredSearches.length} searches match (showing ${startIndex + 1}-${Math.min(endIndex, filteredSearches.length)})`;

    let tableHTML = `
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="bg-stone-700 text-white">
            <th class="border border-gray-300 px-3 py-2 text-left">Timestamp</th>
            <th class="border border-gray-300 px-3 py-2 text-left">Type</th>
            <th class="border border-gray-300 px-3 py-2 text-left">Query</th>
            <th class="border border-gray-300 px-3 py-2 text-center">Results</th>
            <th class="border border-gray-300 px-3 py-2 text-left">Top Results</th>
          </tr>
        </thead>
        <tbody>
    `;

    pageSearches.forEach((search, index) => {
      const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
      const timestamp = search.timestamp?.toDate ? search.timestamp.toDate() : new Date(search.timestamp);
      const formattedTime = timestamp.toLocaleString();

      const typeDisplay = search.searchType
        .replace('employee-', 'Emp: ')
        .replace('directory', 'Directory')
        .replace('faq', 'FAQ');

      // Format results preview
      let resultsPreview = '-';
      if (search.results && search.results.length > 0) {
        if (search.searchType === 'directory') {
          resultsPreview = search.results.slice(0, 3).map(r => r.subject).filter(Boolean).join(', ');
          if (search.results.length > 3) resultsPreview += '...';
        } else if (search.searchType === 'faq') {
          resultsPreview = search.results.slice(0, 2).map(r => r.question).filter(Boolean).join('; ');
          if (search.results.length > 2) resultsPreview += '...';
        }
      }

      tableHTML += `
        <tr class="${bgClass} hover:bg-stone-100">
          <td class="border border-gray-300 px-3 py-2 whitespace-nowrap text-xs">${formattedTime}</td>
          <td class="border border-gray-300 px-3 py-2">${typeDisplay}</td>
          <td class="border border-gray-300 px-3 py-2 font-medium">${search.query}</td>
          <td class="border border-gray-300 px-3 py-2 text-center">${search.resultCount}</td>
          <td class="border border-gray-300 px-3 py-2 text-xs text-gray-600 max-w-xs truncate">${resultsPreview}</td>
        </tr>
      `;
    });

    tableHTML += `
        </tbody>
      </table>
    `;

    elements.searchAdminDisplay.innerHTML = tableHTML;

    // Update pagination controls
    if (totalPages > 1) {
      elements.paginationControls?.classList.remove('hidden');
      elements.pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      elements.prevPageBtn.disabled = currentPage === 1;
      elements.nextPageBtn.disabled = currentPage === totalPages;
    } else {
      elements.paginationControls?.classList.add('hidden');
    }
  }

  function goToPreviousPage() {
    if (currentPage > 1) {
      currentPage--;
      renderSearchTable();
    }
  }

  function goToNextPage() {
    const totalPages = Math.ceil(filteredSearches.length / searchesPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderSearchTable();
    }
  }

  function performDirectorySearch(isFinalSearch = false) {
    const query = elements.dirSearchInput.value.trim();
    const floor = elements.dirFloorFilter.value;

    if (isFinalSearch && query.toLowerCase() === "key to the bathroom") {
      window.location.hash = '#/employees';
      return;
    }

    if (query.toLowerCase() === '#/employees') {
      window.location.hash = '#/employees';
      return;
    }
    let results = directoryData;
    if (query) { results = directoryFuse.search(query).map(r => r.item); }
    if (floor) { results = results.filter(r => r['FLOOR'] === floor); }
    renderDirectoryTable(results, query);
    elements.dirRowCount.textContent = `Found ${results.length} of ${directoryData.length} entries.`;

    // Hide keyboard on mobile after search
    if (isFinalSearch && elements.dirSearchInput) {
      elements.dirSearchInput.blur();
    }

    // Log search query to Firestore with results
    if (isFinalSearch && query && window.logSearchQuery) {
      window.logSearchQuery('directory', query, results.length, results);
    }
  }
  
  function performFaqSearch(isFinalSearch = false) {
      const query = elements.faqSearchInput.value.trim();

      if (isFinalSearch && query.toLowerCase() === "key to the bathroom") {
        window.location.hash = '#/employees';
        return;
      }

      const results = query ? faqFuse.search(query).map(r => r.item) : faqData;
      renderFaqCards(results, query);
      elements.faqRowCount.textContent = `Found ${results.length} of ${faqData.length} questions.`;

      // Hide keyboard on mobile after search
      if (isFinalSearch && elements.faqSearchInput) {
        elements.faqSearchInput.blur();
      }

      // Log search query to Firestore with results
      if (isFinalSearch && query && window.logSearchQuery) {
        window.logSearchQuery('faq', query, results.length, results);
      }
  }

  // --- Event Listeners ---
  window.addEventListener('hashchange', handleRouteChange);
  
  // Directory Listeners
  elements.dirFloorFilter.addEventListener('change', () => performDirectorySearch(true));
  elements.dirSearchInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      event.preventDefault();
      performDirectorySearch(true);
    }
  });
  elements.dirSearchButton.addEventListener('click', () => performDirectorySearch(true));
  elements.dirResetButton.addEventListener('click', () => {
    elements.dirSearchInput.value = '';
    elements.dirFloorFilter.value = '';
    renderDirectoryTable(directoryData);
    elements.dirRowCount.textContent = `Showing all ${directoryData.length} entries.`;
  });

  // FAQ Listeners
  elements.faqSearchButton.addEventListener('click', () => performFaqSearch(true));
  elements.faqSearchInput.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      event.preventDefault();
      performFaqSearch(true);
    }
  });
  elements.faqResetButton.addEventListener('click', () => {
    elements.faqSearchInput.value = '';
    renderFaqCards(faqData);
    elements.faqRowCount.textContent = `Showing all ${faqData.length} questions.`;
  });

  // Shared Listeners
  elements.openPanelBtn.addEventListener('click', () => { elements.infoPanel.style.width = 'min(320px, 90vw)'; });
  elements.closePanelBtn.addEventListener('click', () => { elements.infoPanel.style.width = '0'; });
  elements.storeMapThumbnail.addEventListener('click', () => { elements.fullscreenMap.style.display = 'flex'; });
  elements.fullscreenMap.addEventListener('click', (e) => { if (e.target === elements.fullscreenMap || e.target === elements.fullscreenClose) elements.fullscreenMap.style.display = 'none'; });
  window.addEventListener('scroll', () => { elements.backToTopBtn.classList.toggle('visible', window.scrollY > 300); });
  elements.backToTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
  
  document.querySelectorAll('.help-button').forEach(button => {
    button.addEventListener('click', () => {
        elements.helpModalOverlay.style.display = 'flex';
    });
  });
  
  elements.helpModalOverlay.addEventListener('click', (e) => { if (e.target === elements.helpModalOverlay || e.target === elements.closeHelpModal) elements.helpModalOverlay.style.display = 'none'; });
  document.getElementById('back-to-directory-link').addEventListener('click', () => { elements.helpModalOverlay.style.display = 'none'; });

  // Feedback Modal Listeners
  elements.feedbackLink.addEventListener('click', (e) => { e.preventDefault(); elements.feedbackModalOverlay.style.display = 'flex'; });
  elements.feedbackModalOverlay.addEventListener('click', (e) => { if (e.target === elements.feedbackModalOverlay || e.target === elements.closeFeedbackModal) { elements.feedbackModalOverlay.style.display = 'none'; } });

  // Search Admin Listeners
  if (elements.refreshSearchesBtn) {
    elements.refreshSearchesBtn.addEventListener('click', () => {
      console.log('Force refreshing analytics data...');
      loadSearchAnalytics(true); // Force refresh
    });
  }
  if (elements.testFirestoreBtn) {
    elements.testFirestoreBtn.addEventListener('click', () => testFirestoreConnection());
  }
  if (elements.applyFiltersBtn) {
    elements.applyFiltersBtn.addEventListener('click', () => applyFilters());
  }
  if (elements.clearFiltersBtn) {
    elements.clearFiltersBtn.addEventListener('click', () => clearFilters());
  }
  if (elements.prevPageBtn) {
    elements.prevPageBtn.addEventListener('click', () => goToPreviousPage());
  }
  if (elements.nextPageBtn) {
    elements.nextPageBtn.addEventListener('click', () => goToNextPage());
  }
  if (elements.filterKeyword) {
    elements.filterKeyword.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
  }

  // Suggestion Modal Listeners
  function openSuggestionModal(term) {
    if (term && SUGGESTION_FORM_URL && !SUGGESTION_FORM_URL.includes('YOUR_FORM_ID')) {
        const prefilledUrl = `${SUGGESTION_FORM_URL}${encodeURIComponent(term)}`;
        elements.suggestionIframe.src = prefilledUrl;
        elements.suggestionModalOverlay.style.display = 'flex';
    } else {
        console.error('Suggestion form is not configured correctly.');
    }
  }

  elements.dirDisplayArea.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'open-suggestion-btn') {
        openSuggestionModal(e.target.dataset.term);
    }
  });

  elements.faqDisplayArea.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'open-suggestion-btn') {
        openSuggestionModal(e.target.dataset.term);
    }
  });

  function closeSuggestionModal() {
    elements.suggestionModalOverlay.style.display = 'none';
    elements.suggestionIframe.src = '';
  }
  elements.suggestionModalOverlay.addEventListener('click', (e) => { if (e.target === elements.suggestionModalOverlay) { closeSuggestionModal(); } });
  elements.closeSuggestionModal.addEventListener('click', closeSuggestionModal);

  // Auth Modal Listeners
  function closeAuthModal() {
    elements.authModalOverlay.style.display = 'none';
    elements.authEmailInput.value = '';
    elements.authPasswordInput.value = '';
    elements.authError.textContent = '';
    if (window.location.hash.includes('employees')) {
        window.location.hash = '#/directory';
    }
  }

  elements.closeAuthModal.addEventListener('click', closeAuthModal);
  elements.authModalOverlay.addEventListener('click', (e) => {
    if (e.target === elements.authModalOverlay) {
      closeAuthModal();
    }
  });

  async function handleLogin() {
    const email = elements.authEmailInput.value.trim();
    const password = elements.authPasswordInput.value;

    if (!email || !password) {
      elements.authError.textContent = 'Please enter both email and password.';
      return;
    }

    if (!window.signInUser) {
      elements.authError.textContent = 'Firebase Auth is not ready yet. Please wait a moment.';
      return;
    }

    try {
      await window.signInUser(email, password);
      elements.authEmailInput.value = '';
      elements.authPasswordInput.value = '';
      elements.authError.textContent = '';
      handleRouteChange();
    } catch (error) {
      console.error('Login error:', error);
      elements.authError.textContent = error.message || 'Login failed. Please try again.';
    }
  }

  async function handleCreateAccount() {
    const email = elements.authEmailInput.value.trim();
    const password = elements.authPasswordInput.value;

    if (!email || !password) {
      elements.authError.textContent = 'Please enter both email and password.';
      return;
    }

    if (!window.firebaseAuth || !window.createUserAccount) {
      elements.authError.textContent = 'Firebase is not ready yet. Please wait a moment.';
      return;
    }

    try {
      await window.createUserAccount(email, password);
      elements.authEmailInput.value = '';
      elements.authPasswordInput.value = '';
      elements.authError.textContent = '';
      handleRouteChange();
    } catch (error) {
      console.error('Account creation error:', error);
      elements.authError.textContent = error.message || 'Account creation failed. Please try again.';
    }
  }

  elements.authLoginBtn.addEventListener('click', handleLogin);
  elements.authCreateBtn.addEventListener('click', handleCreateAccount);

  elements.authPasswordInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      handleLogin();
    }
  });

  // Login/Logout button listeners
  elements.loginBtn.addEventListener('click', () => {
    elements.authModalOverlay.style.display = 'flex';
    elements.authEmailInput.focus();
  });

  elements.logoutBtn.addEventListener('click', async () => {
    if (!window.signOutUser) {
      alert('Firebase Auth is not ready yet.');
      return;
    }

    try {
      await window.signOutUser();
      window.location.hash = '#/directory';
    } catch (error) {
      console.error('Logout error:', error);
      alert('Failed to log out. Please try again.');
    }
  });

  // Persistent panel logout button
  elements.persistentLogoutBtn.addEventListener('click', async () => {
    if (!window.signOutUser) {
      alert('Firebase Auth is not ready yet.');
      return;
    }

    try {
      await window.signOutUser();
      window.location.hash = '#/directory';
    } catch (error) {
      console.error('Logout error:', error);
      alert('Failed to log out. Please try again.');
    }
  });

  // Panel minimize/expand toggle listeners
  elements.minimizePanelBtn.addEventListener('click', togglePanel);
  elements.panelMinimized.addEventListener('click', togglePanel);

  // Profile settings listeners
  if (elements.saveDisplayNameBtn) {
    elements.saveDisplayNameBtn.addEventListener('click', saveDisplayName);
  }
  if (elements.displayNameInput) {
    elements.displayNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        saveDisplayName();
      }
    });
  }

  // Function to update user info display
  async function updateUserInfoDisplay(user) {
    if (user) {
      // User is logged in
      elements.loginBtn.classList.add('hidden');
      elements.userInfo.classList.remove('hidden');

      // Load display name from Firestore
      let displayName = user.email;
      if (window.getUserDisplayName) {
        const savedDisplayName = await window.getUserDisplayName();
        if (savedDisplayName) {
          displayName = savedDisplayName;
          currentUserDisplayName = savedDisplayName;
        }
      }

      // Show display name or email
      elements.userEmail.textContent = displayName;

      // Generate initials from display name or email
      const initials = displayName.slice(0, 2).toUpperCase();
      if (elements.userAvatar) {
        elements.userAvatar.textContent = initials;
      }

      // Get and display user role
      const role = await getUserRole();
      const roleDisplay = role === 'admin' ? 'üëë Admin' : 'üë§ Employee';
      elements.userRole.textContent = roleDisplay;

      // Update persistent panel (both minimized and expanded states)
      if (elements.persistentEmployeePanel) {
        elements.persistentEmployeePanel.classList.remove('hidden');
        elements.persistentUserEmail.textContent = displayName;
        elements.persistentUserRole.textContent = roleDisplay;
        elements.persistentUserAvatar.textContent = initials;
        elements.minimizedAvatar.textContent = initials;

        // Set the panel to the saved state (minimized or expanded)
        updatePanelState();
      }
    } else {
      // User is logged out
      elements.loginBtn.classList.remove('hidden');
      elements.userInfo.classList.add('hidden');
      elements.userEmail.textContent = '';
      elements.userRole.textContent = '';
      currentUserDisplayName = '';
      if (elements.userAvatar) {
        elements.userAvatar.textContent = '';
      }

      // Hide persistent panel
      if (elements.persistentEmployeePanel) {
        elements.persistentEmployeePanel.classList.add('hidden');
        // Reset back-to-top button position
        elements.backToTopBtn.classList.remove('with-employee-panel');
        elements.backToTopBtn.classList.remove('with-employee-panel-minimized');
      }
    }
  }

  // Make functions available globally for Firebase module
  window.updateUserInfoDisplay = updateUserInfoDisplay;
  window.handleRouteChange = handleRouteChange;

  // --- Initial Kick-off ---
  // Call routing immediately on page load
  // For /#/employees, this will show auth modal (Firebase not loaded yet, so not authenticated)
  // Firebase will re-run routing once auth state is confirmed
  handleRouteChange();
});
</script>
    <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCcTGIrOtn-xT-mtXGptP4rCRsFC-eHK68",
    authDomain: "store-directory-3.firebaseapp.com",
    projectId: "store-directory-3",
    storageBucket: "store-directory-3.firebasestorage.app",
    messagingSenderId: "536813676503",
    appId: "1:536813676503:web:d096f92f90821c6ec84d92",
    measurementId: "G-X2RXD1M90B"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Set persistence to LOCAL before any auth operations
  setPersistence(auth, browserLocalPersistence)
    .then(() => {
      console.log('Firebase Auth persistence set to LOCAL');
    })
    .catch((error) => {
      console.error('Error setting persistence:', error);
    });

  // Make Firebase services available globally
  window.firestoreDb = db;
  window.firebaseAuth = auth;
  console.log('Firebase, Auth, and Firestore initialized successfully');

  // Global function to log search queries
  window.logSearchQuery = async function(searchType, query, resultCount, results = []) {
    if (!query || query.trim() === '') {
      console.log('Skipping empty search query');
      return;
    }

    console.log('Logging search:', { searchType, query, resultCount });

    try {
      // Limit results data to top 10 to avoid document size issues
      const limitedResults = results.slice(0, 10).map(result => {
        // Store only essential fields depending on search type
        if (searchType === 'directory') {
          return {
            subject: result['SUBJECT'] || result.SUBJECT || '',
            floor: result['FLOOR'] || result.FLOOR || '',
            location: result['LOCATION'] || result.LOCATION || ''
          };
        } else if (searchType === 'faq') {
          return {
            question: result['Question'] || result.question || '',
            category: result['Category'] || result.category || ''
          };
        }
        return result;
      });

      const docRef = await addDoc(collection(db, 'searchLogs'), {
        searchType: searchType,
        query: query.trim(),
        resultCount: resultCount,
        results: limitedResults,
        timestamp: new Date()
      });
      console.log('Search logged successfully with ID:', docRef.id);
    } catch (error) {
      console.error('Error logging search to Firestore:', error);
      console.error('Error details:', error.code, error.message);
    }
  };

  // Global function to fetch recent searches (for admin page)
  window.fetchRecentSearches = async function(limitCount = 100) {
    console.log('Fetching recent searches from Firestore...');
    try {
      const q = query(
        collection(db, 'searchLogs'),
        orderBy('timestamp', 'desc'),
        limit(limitCount)
      );
      const querySnapshot = await getDocs(q);
      const searches = querySnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      console.log(`Fetched ${searches.length} search logs`);
      return searches;
    } catch (error) {
      console.error('Error fetching searches from Firestore:', error);
      console.error('Error details:', error.code, error.message);
      return [];
    }
  };

  // Authentication functions
  window.signInUser = async function(email, password) {
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      console.log('User signed in successfully:', userCredential.user.email);
      return userCredential.user;
    } catch (error) {
      console.error('Error signing in:', error);
      throw error;
    }
  };

  window.createUserAccount = async function(email, password) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // Create user document in Firestore
      await setDoc(doc(db, 'users', user.uid), {
        email: email,
        role: 'employee',
        createdAt: serverTimestamp()
      });

      console.log('User account created successfully:', user.uid);
      return user;
    } catch (error) {
      console.error('Error creating user account:', error);
      throw error;
    }
  };

  window.signOutUser = async function() {
    try {
      await signOut(auth);
      console.log('User signed out successfully');
    } catch (error) {
      console.error('Error signing out:', error);
      throw error;
    }
  };

  window.getUserRole = async function() {
    const user = auth.currentUser;
    if (!user) {
      return null;
    }

    try {
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (userDoc.exists()) {
        return userDoc.data().role || 'employee';
      }
      return 'employee';
    } catch (error) {
      console.error('Error getting user role:', error);
      return 'employee';
    }
  };

  // Get user display name
  window.getUserDisplayName = async function() {
    const user = auth.currentUser;
    if (!user) {
      return null;
    }

    try {
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (userDoc.exists()) {
        return userDoc.data().displayName || '';
      }
      return '';
    } catch (error) {
      console.error('Error getting user display name:', error);
      return '';
    }
  };

  // Set user display name
  window.setUserDisplayName = async function(displayName) {
    const user = auth.currentUser;
    if (!user) {
      throw new Error('No user logged in');
    }

    try {
      await setDoc(doc(db, 'users', user.uid), {
        displayName: displayName
      }, { merge: true });
      console.log('Display name saved successfully:', displayName);
    } catch (error) {
      console.error('Error setting user display name:', error);
      throw error;
    }
  };

  // Listen for auth state changes
  onAuthStateChanged(auth, (user) => {
    console.log('Auth state changed:', user ? `User signed in: ${user.email}` : 'User signed out');

    // Update user info display
    if (window.updateUserInfoDisplay) {
      window.updateUserInfoDisplay(user);
    }

    // Always re-run routing when auth state changes to update the UI
    // This handles:
    // 1. Initial Firebase load (restores persisted session or confirms no session)
    // 2. User login/logout actions
    // 3. Session changes
    if (window.handleRouteChange) {
      console.log('Updating routing based on auth state...');
      window.handleRouteChange();
    }
  });

  // Signal that Firebase is ready
  window.firebaseReady = true;
  console.log('Firebase module loaded and ready');
</script>
</body>
</html>
